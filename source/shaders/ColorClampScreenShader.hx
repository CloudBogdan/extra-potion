package shaders;

import flixel.system.FlxAssets.FlxShader;
import utils.Config;

class ColorClampScreenShader extends FlxShader {
    @:glFragmentSource("
        #pragma header

        uniform float uScreenWidth = 128.0;
        uniform float uScreenHeight = 128.0;
        
        vec4 colors[42] = {
            vec4(0.988235294117647,0.988235294117647,0.988235294117647,1.0),
            vec4(0,0,0,1.0),
            vec4(0.972549019607843,0.847058823529412,0.972549019607843,1.0),
            vec4(0.470588235294118,0.470588235294118,0.470588235294118,1.0),
            vec4(0.737254901960784,0.737254901960784,0.737254901960784,1.0),
            vec4(0.72156862745098,0.72156862745098,0.972549019607843,1.0),
            vec4(0.407843137254902,0.533333333333333,0.988235294117647,1.0),
            vec4(0,0.345098039215686,0.972549019607843,1.0),
            vec4(0,0,0.988235294117647,1.0),
            vec4(0.847058823529412,0.72156862745098,0.972549019607843,1.0),
            vec4(0.596078431372549,0.470588235294118,0.972549019607843,1.0),
            vec4(0.407843137254902,0.266666666666667,0.988235294117647,1.0),
            vec4(0.266666666666667,0.156862745098039,0.737254901960784,1.0),
            vec4(0.972549019607843,0.72156862745098,0.972549019607843,1.0),
            vec4(0.972549019607843,0.470588235294118,0.972549019607843,1.0),
            vec4(0.847058823529412,0,0.8,1.0),
            vec4(0.580392156862745,0,0.517647058823529,1.0),
            vec4(0.972549019607843,0.643137254901961,0.752941176470588,1.0),
            vec4(0.972549019607843,0.345098039215686,0.596078431372549,1.0),
            vec4(0.894117647058824,0,0.345098039215686,1.0),
            vec4(0.658823529411765,0,0.125490196078431,1.0),
            vec4(0.988235294117647,0.87843137254902,0.658823529411765,1.0),
            vec4(0.972549019607843,0.470588235294118,0.345098039215686,1.0),
            vec4(0.972549019607843,0.219607843137255,0,1.0),
            vec4(0.658823529411765,0.0627450980392157,0,1.0),
            vec4(0.988235294117647,0.87843137254902,0.658823529411765,1.0),
            vec4(0.988235294117647,0.627450980392157,0.266666666666667,1.0),
            vec4(0.894117647058824,0.36078431372549,0.0627450980392157,1.0),
            vec4(0.533333333333333,0.0784313725490196,0,1.0),
            vec4(0.972549019607843,0.847058823529412,0.470588235294118,1.0),
            vec4(0.972549019607843,0.72156862745098,0,1.0),
            vec4(0.674509803921569,0.486274509803922,0,1.0),
            vec4(0.313725490196078,0.188235294117647,0,1.0),
            vec4(0.847058823529412,0.972549019607843,0.470588235294118,1.0),
            vec4(0.72156862745098,0.972549019607843,0.0941176470588235,1.0),
            vec4(0.72156862745098,0.972549019607843,0.847058823529412,1.0),
            vec4(0.345098039215686,0.847058823529412,0.329411764705882,1.0),
            vec4(0,0.72156862745098,0,1.0),
            vec4(0,0.407843137254902,0,1.0),
            vec4(0,0.988235294117647,0.988235294117647,1.0),
            vec4(0,0.533333333333333,0.533333333333333,1.0),
            vec4(0,0.250980392156863,0.345098039215686,1.0)
        };

        void main() {
            float pixelWidth = 1.0 / uScreenWidth;
            float pixelHeight = 1.0 / uScreenHeight;
            
            vec2 coords = vec2(openfl_TextureCoordv);
            coords.x = floor(coords.x/pixelWidth)*pixelWidth + pixelWidth / 2.0;
            coords.y = floor(coords.y/pixelHeight)*pixelHeight + pixelHeight / 2.0;
            
            vec4 color = flixel_texture2D(bitmap, coords);

            float minDiff = 10000.0;
            vec4 minColor = vec4(0.0, 0.0, 0.0, 1.0);

            for (int i = 0; i < colors.length(); i ++) {
                float diff = distance(colors[i], color);
                if (diff < minDiff) {
                    minDiff = diff;
                    minColor = colors[i];
                }
            }
            
            gl_FragColor = minColor;
        }
    ")

    public function new() {
        super();

        uScreenWidth.value = [Config.CANVAS_WIDTH];
        uScreenHeight.value = [Config.CANVAS_HEIGHT];
    }
}